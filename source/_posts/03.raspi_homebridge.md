---
title: 树莓派上的HomeBridge
date: 2021-09-13 17:09:49
categories: 
- Raspi&Arduino
tags: 
- Linux
- RaspberryPi
- HomeBridge
- HomeKit
---

# Raspi Homebridge configuration

### 安装Homebridge

#### 方法一：直接安装Homebridge镜像

github地址：`https://github.com/homebridge/homebridge-raspbian-image/releases`

*<!-- more -->*

#### 方法二：手动安装

Terminal中，依次执行：

```shell
curl -sL https://deb.nodesource.com/setup_12.x | sudo bash - 
# setup repo

sudo apt-get install -y nodejs gcc g++ make python
# 可以在此之前执行 `sudo apt-get upgrade`
# `-y` 意思是可以省略确认提示

node -v
# 查看已安装node的版本

sudo npm i -g npm
# upgrade npm

sudo npm install -g --unsafe-perm homebridge homebridge-config-ui-x
# 如果npm下载太慢或失败，可以在install命令后添加 --registry https://registry.npm.taobao.org 使用淘宝 npm 镜像

sudo hb-service install --user homebridge
# hb-service可以将homebridge设置为服务，并支持开机自启。这会创建一个名为homebridge的用户来运行homebridge，
# 同时生成配置文件保存在 /var/lib/homebridge/config.json
# 记住最后显示的ip地址；默认用户名admin，密码admin

```

### 通过Homekit控制USB口的供电

Terminal中，安装uhubctl

```shell
sudo apt install libusb-1.0-0-dev
git clone https://github.com/mvp/uhubctl
cd uhubctl
make
sudo make install
```

控制供电的命令：

```shell
sudo uhubctl -l 1-1 -p 2 -a on  # turn power on
sudo uhubctl -l 1-1 -p 2 -a off # turn power off
```

接下来需要配置 udev USB 权限解决权限问题（否则必须使用 `sudo` 来以 root 权限运行 uhubctl，而默认情况下 Home­bridge 不会以 root 运行）。

1. 运行 `sudo uhubctl`，查看要控制的端口的 VID（或直接在 [uhubctl 文档](https://github.com/mvp/uhubctl#compatible-usb-hubs)中查看）。

2. 将下列 udev 规则添加至 `/etc/udev/rules.d/52-usb.rules` 文件，注意替换规则中的 VID：

   - 在树莓派 3B+ 上：

     ```none
     SUBSYSTEM=="usb", ATTR{idVendor}=="0424", MODE="0666"
     ```

   - 在树莓派 4 上（USB2 和 USB3 各一条）：

     ```none
     SUBSYSTEM=="usb", ATTR{idVendor}=="2109", MODE="0666"
     SUBSYSTEM=="usb", ATTR{idVendor}=="1d6b", MODE="0666"
     ```

3. 要使 udev 规则生效，执行：

   ```shell
   sudo udevadm trigger --attr-match=subsystem=usb
   ```

4. 不使用 `sudo`，执行以下命令，确认能够正常控制 USB 供电的开关：

   ```bash
   uhubctl -l 1-1 -p 2 -a on  # turn power on
   uhubctl -l 1-1 -p 2 -a off # turn power off
   ```

在homebridge中安装Script2插件

进入config，添加以下内容：

```json
"accessories": [
    {
        "accessory": "Script2",
        "name": "LED Light",
        "on": "uhubctl -l 1-1 -p 2 -a on",
        "off": "uhubctl -l 1-1 -p 2 -a off",
        "state": "uhubctl -l 1-1 -p 2 2>/dev/null | grep -c 'power'",
        "on_value": "1"
    }
]
```





### 米家设备token获取

`https://www.home-assistant.io/integrations/xiaomi_miio#xiaomi-cloud-tokens-extractor-1`

github地址： `https://github.com/PiotrMachowski/Xiaomi-cloud-tokens-extractor/blob/master`





### HomeKit摄像头（暂未成功)

bilibili地址：

`https://b23.tv/vu977y`

```
把吃灰的树莓派利用起来，DIY一个支持原生HomeKit的摄像头。还可以自定义分辨率，码率，帧率。如果家里有家庭中枢，还可以进行外网访问。
https://bit.ly/2VTjtZJ
http://homebridge.local
https://bit.ly/2VT0cIn
https://bit.ly/3jTC8wR
```

用到的github项目地址：

`https://github.com/Sunoo/homebridge-camera-ffmpeg`

`https://sunoo.github.io/homebridge-camera-ffmpeg/configs/Raspberry-Pi-with-Camera-Module.html`



1 安装HomeBridge 镜像

给树莓派开机（不需要接鼠标、键盘、HDMI口），等待一会儿，在手机上连接名为 `HomeBridge WIFI Setup` 的WiFi，输入wifi密码（如果树莓派搜索不到家里的wifi，等一会儿重试即可）

ssh：用户名`pi@192.168.31.214`，密码`raspberry`

2 安装HomeBridge插件 `Camera FFMpeg`

3 创建service

```shell
sudo apt install v4l2loopback-dkms

Edit /boot/config.txt and change gpu_mem=128 to gpu_mem=256 (or use raspi-config)
```

Create file `/etc/systemd/system/camera-loopback.service`

```shell
[Unit]
Description=Set up loopback cameras

[Service]
ExecStartPre=/sbin/modprobe v4l2loopback devices=2
ExecStart=/usr/local/bin/ffmpeg -f video4linux2 -input_format yuv420p -video_size 1280x720 -i /dev/video0 -codec copy -f v4l2 /dev/video1
Restart=always
RestartSec=2

[Install]
WantedBy=default.target
```

Activate with `sudo systemctl enable camera-loopback` 

and start with `sudo systemctl start camera-loopback`

4 编辑HomeBridge的`config.json`

在platforms后面添加：

```json
        {
            "name": "Camera FFmpeg",
            "cameras": [
                {
                    "name": "Raspberry Pi Camera",
                    "manufacturer": "Edddd",
                    "model": "RPI HomeKit Camera",
                    "serialNumber": "12345678",
                    "unbridge": true,
                    "videoConfig": {
                        "source": "-f video4linux2 -i /dev/video1",
                        "maxStreams": 1,
                        "maxWidth": 1280,
                        "maxHeight": 720,
                        "maxFPS": 30,
                        "maxBitrate": 1000,
                        "forceMax": true,
                        "vcodec": "h264_omx"
                    }
                }
            ],
            "platform": "Camera-ffmpeg"
        }
```

